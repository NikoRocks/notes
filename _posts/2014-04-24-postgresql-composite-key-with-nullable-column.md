---
layout: index
title: PostgreSQL. Составной ключ с nullable-колонкой
---

Ситуация: есть составной ключ из двух колонок, одна из них может быть `NULL`.
Вопрос: являются ли идентичными записи со значениями ключей
`[1, NULL]` и `[1, NULL]`?

Ответ: зависит от СУБД. В PostgreSQL они, например, неидентичны. Почему? Потому
что `NULL <> NULL`, в том числе при проверке на уникальность при обновлении
индекса, хотя чисто интуитивно такое поведение, возможно, не очень понятно.
Эта СУБД строго следует стандарту, в отличии "от некоторых других", о чем они
гордо пишут в [документации][документация]:

> This behavior conforms to the SQL standard, but we have heard that other SQL
> databases may not follow this rule...

Решением этой проблемы (проблемы ли? На мой скромный взгляд, это чертовски
правильное поведение!) является создание двух индексов с условием вместо одного:

```sql
CREATE UNIQUE INDEX nullable_column
ON the_table (not_nullable_column, nullable_column)
WHERE nullable_column IS NULL;

CREATE UNIQUE INDEX nullable_column
ON the_table (not_nullable_column, nullable_column)
WHERE nullable_column IS NOT NULL;
```

Выглядит как хак, некрасиво? В зависимости от того, как относиться к стандарту.
Тут он - соблюдается. А в этом вашем MySQL - нет.

Вообще, я недавно узнал о существовании в мускуле [strict-режима][strict-mode],
который, как понятно из названия, относится ко вводимым данным "более строго" и
валится с ошибкой при обработке запроса, вместо того чтобы скромно записать
предупреждение в лог, который все равно никто не читает. Например, он запрещает
вводить невалидные значения для перечислений (enum-ов), а не тупо сбрасывает все
до пустой строки (фу!). Или же ругается, когда введено число, выходящее за
диапазоны поля (TINYINT UNSIGNED, к примеру), а не уменьшает его до ближайшей
границы диапазона (бред!). А вот PostgreSQL так делает искаропки!

Вообще, наличие этого режима навело меня на мысль, что MySQL и PHP - два сапога
пара в этом вашем вебе и стóят друг друга. В современных фреймворках для
пыхи strict-режим хотя бы выставляют по-умолчанию, когда же станут делать это и
для мускуля?



[документация]: http://www.postgresql.org/docs/9.3/interactive/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS
[strict-mode]: http://dev.mysql.com/doc/innodb/1.1/en/innodb-other-changes-strict-mode.html
